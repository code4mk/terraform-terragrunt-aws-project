name: Terraform Terragrunt Action

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Triggered manually from GitHub UI

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Print HOME directory
        run: |
          echo "The HOME directory is: $HOME"
          ls -la $HOME

      - name: Set up Terraform CLI
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.8.0  # Replace with your desired version

      - name: Set up Terragrunt CLI
        run: |
          wget -qO /tmp/terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.57.0/terragrunt_linux_amd64
          sudo chmod +x /tmp/terragrunt
          sudo mv /tmp/terragrunt /usr/local/bin/terragrunt
          echo "âœ… Terragrunt CLI setup completed!"

      - name: Create Terraform CLI config directory and credentials file
        run: |
          sudo mkdir  $HOME/.terraform.d
          ls -la /home/runner
          echo "âœ… Terraform CLI config directory created!"

      - name: Configure Terraform Cloud credentials
        env:
          TERRAFORM_CREDENTIALS: $HOME/.terraform.d/credentials.tfrc.json
        run: |
          echo "{\"credentials\": {\"app.terraform.io\": {\"token\": \"${{ secrets.TF_API_TOKEN }}\"}}}" > $TERRAFORM_CREDENTIALS
          echo "ğŸ” Terraform Cloud credentials configured!"

      - name: Run symlink-modules.sh and select workspace
        run: |
          ./symlink-modules.sh
          terragrunt workspace select terragrunt
          echo "ğŸ”— Symlink modules and workspace selection completed!"

      - name: Terragrunt init
        run: |
          cd ./environment/stage
          terragrunt init
          echo "ğŸ”§ Terragrunt init completed!"

      - name: Terragrunt plan
        run: |
          cd ./environment/stage
          terragrunt plan -out=tfplan
          echo "ğŸ“ Terragrunt plan completed!"

      - name: Display success message
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸš€ Terraform Terragrunt Action triggered manually!"
